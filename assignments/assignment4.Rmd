---
title: "ESM 232 Assignment 4"
author: "Ruben Sanchez Ramirez"
date: "April 26, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}

# Attach packages
library(tidyverse)
library(janitor)
library(here)
library(ggplot2)
library(purrr)
library(sensitivity)
library(pse)

```

```{r}

# Read in data 
clim_data <- read_table2(here::here("assignments","data","clim.txt")) %>% 
  clean_names()

```

```{r}

# call the function
source("./R/almond_yield.2.R")

```

### **Almond model sensitivity:**

 1) create a function based on your almond yield function that returns the mean and inter-annual variation in yield anomaly. You can either adapt the function or write another function that simply calls your current almond function, and computes mean and inter-annual variation.

2) Perform a  Latin Hypercube (LHR) sensitivity analysis of the 2 coefficients on precipitation - assume that these have a uniform distribution ("qunif") with min value 20% below the default value and max value 20% above the default value. This is a common way to look at uncertainty when you don't know much about the parameter distribution. 

3) Create two plots, 1) the scatter plot that shows how output change with parameter uncertainty and 2) the plot of the PRCC. In your Rmarkdown, note which of the two parameters contribute more to parameter uncertainty.

***

```{r almondsens}


# Name the factors which we will look at
factors = c("p.coeff1", "p.coeff2")

# Set how many parameter sets to run
nsets=100

# choose distributions for parameters 
q = c("qunif", "qunif")
# Min 20% below mean, Max 20% above the mean
q.arg = list(list(min=-0.084, max=-0.056), list(min=0.00344, max=0.00516))

# generate samples from LHS
sens_almond = LHS(NULL,factors,nsets,q,q.arg)
sens_pars = get.data(sens_almond)
head(sens_pars)

# Run the model for all of the parameters generated by LHS using pmap
res = sens_pars %>% pmap(almond_yield.2,climate=clim_data)

# pmap returns a list 
head(res)

# Turn results in to a dataframe for easy display/analysis
resd = res %>% map_dfr(`[`,c("mean_yield","sd"))

# Results need to be in a matrix
# each column is a different parameter set
sens_almond = pse::tell(sens_almond, t(as.matrix(resd)), res.names=c("Mean Yield","Standard Deviation (Yield)"))

```

```{r}

# Use built in LHS functions to analyze parameter sensitivity 
# Create a scatter plot that shows how output change with parameter uncertainty
pse::plotscatter(sens_almond, col="chocolate", cex=5)

```
***

### **Plot of the PRCC**

```{r}

# Create prcc plot
pse::plotprcc(sens_almond)
sens_almond$prcc

```
***

_**Based on the results from the two plots, the coefficient related to the P.coeff2 parameter has more of a consistent effect on the overall yield mean and standard deviation than that of the P.coeff1 parameter.**_
_**The partial rank correlation coefficients of P.coeff2 are both about 0.999, while the ones for P.coeff1 are 0.822 & 0.759. P.coeff2 has a higher and more well defined contribution to the yield anomaly uncertainty.**_

***


