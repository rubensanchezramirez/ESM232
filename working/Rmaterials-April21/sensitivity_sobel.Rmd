---
title: "Sensitivity_sobel"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sensitivity)
library(pse)
library(tidyverse)
library(gridExtra)
```

Another example

Atmospheric Conductance as a function of windspeed, vegetation height and parameters

![Catm](./Catm_fig.jpeg)

```{r setsen, echo=TRUE, eval=TRUE}

source("./Catm.R")
# names of our parameters
factors = c("mult_zo","mult_zd", "v","height")
# type of distributions they arise from
q = c("qnorm", "qunif", "qnorm","qnorm")
# parameters for those distributions
q.arg = list(list(mean=0.1,sd=0.01), list(min=0.6,max=0.8), list(mean=5, sd=1), 
             list(mean=20, sd=1))

nsets=200
sens_Catm = LHS(NULL,factors,nsets,q,q.arg, nboot=500)
# save parameter values
sens.pars = get.data(sens_Catm)

head(sens.pars)
ggplot(sens.pars, aes(mult_zo))+geom_density()
ggplot(sens.pars, aes(x=mult_zo, y=mult_zd))+geom_density_2d()
```

Now run the model - and give results to sensitivity analysis data structure generated by LHS 
* this allows us to take advantage of LHS functions for plotting and analysis

**tell**

provides the sensitivity structure created by LHS, results from model simulations

* can also provide names for results

We can then use two plotting commands

* **plotscatter**
  * given x-y plot of parameter and result
* **plotprcc**
  * Partial rank correlation coefficient 
* **plotecdf**
  * Cummulatative distribution of results - gives you range

```{r runsen, echo=TRUE, eval=TRUE}

# run the model
source("./Catm.R")
sens_res = Catm(v=sens.pars$v, height=sens.pars$height, zm=30, mult_zo=sens.pars$mult_zo, mult_zd=sens.pars$mult_zd)

sens_Catm = tell(sens_Catm, sens_res, res.names="ga")
plotscatter(sens_Catm)

# note it can take standard R plotting parameters
plotscatter(sens_Catm, col="darkgreen", cex=5, ylab="Atm Cond (mm/s)")

# whats is the range of results

plotecdf(sens_Catm, col="red", lwd=5, xlab="Atm Cond (mm/s)")

# we can also plot partial correlation coefficients
plotprcc(sens_Catm)
# and we can look at the actual values
sens_Catm$prcc
# note because this is a linear model correlations are high for both parameters - and similar

```


## Sobel

Sobel sensitivity analysis is similar to LHS approach 
Breaks variance of output into 

* variance associated directly with parameter alone (fraction associated with each parameter, sum to 1)
* variance associated with parameter and interaction with other parameters (sum can be more than 1)


Similar workflow to LHS

* run sobel to get parameter sets in a sensitivity analysis object
* run model with those parameter sets
* tell the senstivity object about results associated with each parameter set
* look at sensitivity analysis metric from sobel


#  Example - lets try it both ways

Atmospheric Conductance as a function of windspeed, vegetation height and parameters

```{r}

source("./Catm.R")
# names of our parameters
# number of parameters 

np=10000
mult_zo = rnorm(mean=0.1,sd=0.01, n=np)
mult_zd = runif(min=0.6,max=0.8, n=np)
v = rnorm(mean=5, sd=1, n=np)
height = rnorm(mean=20, sd=1, n=np)

# generate two examples of random number from parmeter distributions

X1 = cbind.data.frame(mult_zo, mult_zd, v, height=height)

# repeat sampling
mult_zo = rnorm(mean=0.1,sd=0.01, n=np)
mult_zd = runif(min=0.6,max=0.8, n=np)
v = rnorm(mean=5, sd=1, n=np)
height = rnorm(mean=20, sd=1, n=np)

X2 = cbind.data.frame(mult_zo, mult_zd, v, height=height)

sens_Catm_sobel = sobol2007(model = NULL, X1, X2, nboot = 100)


# run model for all parameter sets
res = mapply(FUN=Catm,  mult_zo=sens_Catm_sobel$X$mult_zo,mult_zd=sens_Catm_sobel$X$mult_zd, height=sens_Catm_sobel$X$height, v=sens_Catm_sobel$X$v, MoreArgs=list(zm=30))


sens_Catm_sobel = sensitivity::tell(sens_Catm_sobel,res, res.names="ga")

# first-order indices (main effect without co-variance)
sens_Catm_sobel$S

# total sensitivity index -note that this partitions the output variance - so values sum to 1
sens_Catm_sobel$T

# The difference between the main effect and total effect can tell us something about how the parameter influences results
# so in the main effect we include interactions with other parameters


print(sens_Catm_sobel)
plot(sens_Catm_sobel)

# compare with LHS and PRCC
sens_Catm$prcc


sens_Catm_sobel$S
sens_Catm_sobel$T

# make a data frame for plotting
both = cbind.data.frame(sens_Catm_sobel$X, gs=sens_Catm_sobel$y)

# look at response of conductance to the two most important variables
ggplot(both, aes(v,gs, col=height))+geom_point()+labs(y="Conductance (mm/s)", x="Windspeed")

```

# Assignment


Adjust your almond model to  output ONLY the mean almond yield anomoly IF the users sets parameter (e.g mean_only = TRUE))

Perform a sensitivity analysis of how mean anomaly varies ALL of the parameters used in the yield model  
Assume parameters are normally distribute with standard deviation of 20% mean value

Rank the parameters in term of their sensitivity
Graph uncertainty in mean yield anomaly across all parameter uncertainty (boxplot and cummulative distribution of the output).

Repeat using the LHS and Sobel methods

Repeat using twice as many parameter sets as you did in your first sensitivity analysis - and look at how this changes the sensitivity results

Submit R markdown and short write up describing what you learned from the sensitivity analysis
