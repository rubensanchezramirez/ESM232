---
title: "Stability"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(deSolve)
library(sensitivity)
```

# Ways to use dynamic models 

Goal: To provide insight into environmental systems, and how they respond to intervention/disturbance/change

* sensitivity analysis of output (output generated by solving differential equation to see system evolution in time or space)
  * output response to variation in inputs/parameters
  * quantifying how summary measures respond to variation in inputs/parameters
* examine derivative at different values (simpler, not solving required but just tells you how system will change given a particular state)
  * how does stability vary with inputs/parameters

# Another Application

Modeling carbon growth in a forest

r is growth rate
K is maximum carbon capacity of the forest

```{r forest}
source("./dpopgrowth.R")

# set parameters
forestparms = list(K=100,r=0.2)

# create a time sequence
tm = seq(from=1,to=100)

# start a small forest
postfire_initial_carbon = 2

# watch it grow
forest = ode(y=postfire_initial_carbon, times=tm, dpopgrowth, parms=forestparms)

colnames(forest)=c("time","carbon")
ggplot(as.data.frame(forest),aes(time, carbon) )+geom_line()


```

Now lets add disturbance

# Disturbance

harvest the forest 
2 options
*a fixed harvest every year
*proportional harvest (% of current stock)

```{r harvest}

# fixed amount per year
source("./dharvest.R")

# try it out
tm = seq(from=1, to=500)
Pinitial = 1
gps = list(harv=0.18, K=100, r=0.2)
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()

# lets vary the harvest rates from 0.0 to 0.4
harvestr = seq(from=0.0, to=0.4, by=0.025)

# save all of the trajectories


# use a wrapper function to just return the carbon trajectories
getcarbon = function(Pinitial, tm, harv, K, r, hfunc) {
  gps = list(harv=harv, K=K, r=r)
  res = ode(Pinitial,tm, hfunc, gps)
  colnames(res)=c("time","carbon")
  res=as.data.frame(res)
  return(carbon=res$carbon)
}

# apply this function to all harvest values
res = harvestr %>% map_dfc(~getcarbon( Pinitial=Pinitial, tm=tm, K=100, r=0.2, hfun=dharvest, harv=.x))
# rows are time, columns are carbon for each harvest scenario
colnames(res)=harvestr
res=as.data.frame(res)
res$time=tm
# put in to a form where we can plot
resl = gather(res, key="harvestr",value="carbon", -time)
ggplot(resl,aes(time, carbon, col=harvestr))+geom_line()


# notice that stable forest value changes with harvest rates

# notes that some forests are not stable - (or stablity is zero)

# see this at the beginning - plot the first 10 years
ggplot(subset(resl, time < 10),aes(time, carbon, col=harvestr))+geom_line()

```

Try different harvest rates...notice how carbon growth changes...what does stability mean - can you find parameter sets that lead to a stable non-zero forest

We could do some sensitivity analysis to see how harvest rate, and growth rate interact to control where the forest ends up after 10 years and 50 years (short and long planning horizons)

We will use our compute metrics and wrapper to make this easy

```{r harvestsend}

# fixed amount per year
source("./dharvest.R")


# lets assume a uniform distribution of harvest rates
# and of normal growth rates
np=200

r = rnorm(mean=0.3, sd=0.05, n=np)
harv = runif(min=0.0, max=0.4, n=np)
X1 = cbind.data.frame(r=r, harv=harv)

# repeat to get our second set of samples
r = rnorm(mean=0.3, sd=0.05, n=np)
harv = runif(min=0.0, max=0.4, n=np)
X2 = cbind.data.frame(r=r, harv=harv)

# create our sobel object and get sets ofparameters for running the model

sens_forest = soboljansen(model = NULL,X1, X2, nboot = 300)

# do a quick test
# try it out
tm = seq(from=1, to=50)
Pinitial = 1
parms = list(r=sens_forest$X[1,"r"], harv=sens_forest$X[1,"harv"], K=100)
res = ode(y=Pinitial,times=tm, func=dharvest, parms=parms)
res=as.data.frame(res)
colnames(res)=c("time","C")

# compute our two metrics of interest - harvest after 10 and 50 years
compute_metrics = function(res) {
 C50 = res[50]
 C10 = res[10]
return(list(C50=C50, C10=C10))}

# use a wrapper function to just return the carbon trajectories
p_wrapper = function(r,harv, K, Pinitial, simtimes, func) {
    parms = list(r=r, K=K, harv=harv)
    result = ode(y=Pinitial, times=simtimes, func=func, parms=parms) 
    result=as.data.frame(result)
    colnames(result)=c("time","C")
  # get metrics
  metrics=compute_metrics(result$C)
  return(metrics)
}

# notice how we added in K, a parameter that we are NOT varying

# try it out
tm = seq(from=1, to=50)
Pinitial = 1

allresults = sens_forest$X %>% pmap(p_wrapper, K=100, Pinitial=Pinitial, simtimes=tm, func=dharvest)

# extract out results from pmap into a data frame
allres = allresults %>% map_dfr(`[`,c("C10","C50"))

tmp = allres %>% gather(key="metric", value="value")
ggplot(tmp, aes(metric, value, col=metric))+geom_boxplot()

# link with parameters to see how parameters together
# impact something we care aboue C50

allresp = cbind.data.frame(r=sens_forest$X$r, harv=sens_forest$X$harv, allres)
ggplot(allresp, aes(harv, C50, col=r))+geom_point()

# notice how we can see the impact of harvesting - and how growth rates reduce the sustainable harvest
```



A useful analysis can be to look at where the system state is stable (no change in state)

We can look at how the derivative (rate of change varies)


One way we can do this WITHOUT solving the differential equation is to look at the derivatives at different values

When the derivative is 0 the system is stable
Positive derivatives are growth
Negative are decline

```{r stability2}

# given some forest characteristics - lets look at derivatives under different harvest rates
lowHrate = 0.015
gps = list(harv=lowHrate, K=100, r=0.05, mincarbon=20)

# look at the derivative over a range of forest sizes

findstable = data.frame(Ccurr=seq(from=1, to=100, by=5))
# notice use of Time=NULL, and map to compute derivative
# for different values of forest biomass
findstable$dervHlow= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, P=.x) ))
                                                  
ggplot(findstable, aes(Ccurr, dervHlow))+geom_point()+geom_hline(yintercept = 0, col="red")

# Populations will be stable when derivative is zero!

# look at a different harvest rate
midHrate=0.02
gps = list(harv=midHrate, K=100, r=0.05, mincarbon=20)
findstable$dervHmid= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, P=.x) ))
 
# try high rate
highHrate=0.05
gps = list(harv=highHrate, K=100, r=0.05, mincarbon=20)
findstable$dervHhigh= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, P=.x) ))
 

# plot them all together
tmp = gather(findstable, key="HarvestRate", value="value", -Ccurr)
ggplot(tmp, aes(Ccurr, value, color=HarvestRate))+geom_point()+geom_hline(yintercept = 0, col="black")+
  labs(x="Forest Biomass", y="Forest Growth Rate")

# notice how with higher harvest rates the stable population will be lower




```

knowing the stability can help you understand the dynamics ofthe system

If we start with a Forest Carbon of 50 and low harvest rate what will happen

If we start with a Forest Carbon of 50 and a high harvest rate what will happen

Try it to find out if you are right
```{r}

gps = list(harv=lowHrate, K=100, r=0.05)
Pinitial=50
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")
ggplot(as.data.frame(res), aes(time, carbon))+geom_point()


gps = list(harv=highHrate, K=100, r=0.05)
Pinitial=50
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")
ggplot(as.data.frame(res), aes(time, carbon))+geom_point()



```


We can more formally find stablity by finding when the derviative of the function is zero




What if we have a slightly different forest management task -  to make harvest a fixed amount of  carbon but only take it if it is above a threshold minimum carbon

Think about how you would explore stablity here

```{r stability}

source("../R/dharvestfixed.R")

# try it out
tm = seq(from=1, to=500)
Pinitial = 500
gps = list(harv=0.015, K=1000, r=0.05, mincarbon=20)

res = ode(Pinitial,tm, dharvestfixed, gps)
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()

#  try a different solver
res = ode(Pinitial,tm, dharvestfixed, gps, method="euler")
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_line()


```
